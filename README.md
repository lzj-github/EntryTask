# Requirements of the System

## Functional Requirements
1. User signup
2. User login : If the login is successful, the relevant user information is displayed, otherwise an error message will be shown.
3.  Edit profile : After a successful login, a user can edit the following information: \
  (1) Upload a picture as his/her profile picture\
  (2) Change his/her nickname (support unicode characters with utf-8 encoding)
User information includes: username (cannot be changed), nickname, profile picture

4. Separate HTTP server and TCP server and put the main logic on TCP server.Backend authentication logic should be done in the TCP server

5. User information must be stored in a MySQL database. Connect by MySQL Go client.



 
## Non-Functional Requirements & Considerations:

#### Robustness
1. Use standard library whenever possible.
2. Horizontal scalablity when traffic surge
3. Code extensibility when needed
4. Avoid single point of failure
5. 

#### Security
1. Web interface will not directly connect to MySQL. For each HTTP request, web interface will send a TCP request to the TCP server, which will handle business logic and query the database.

2. Login frequency check and IP check (such as MaxMind GeoIP2 Database)
3. Login abnormal behavior warning ( such as abnormal region or device )
4. Login behavior logging and analysis ( such as  cracking and web crawler)


## Performance Requirement 

1. Supports up to 1000 login requests per second (from at least 200 unique users)
2. Supports up to 1000 concurrent http requests
3. For test, the initial user data can be directly insert into database. Make sure there are at least 10 million user accounts in the test database.


###  Extendable Functionality ( todos ):
1. Roles and privileges enhancement and management
2. SSO ( Single Sign On ) Central Authentication Service for cross domain login
3. Sign in by OpenId such as QQ, Wechat, google or facebook account 
4. OpenId Authentication for other applications


#### Environment Requirements

Server: Virtual Machine on Working PC\
OS: CentOS 7 x64 or Ubuntu 14.04 above\
DB: MySQL 5.5 or above\
Client: Chrome and Firefox
  

# Design of the System

## Capacity Estimation and Constraints

## Database Design
All tables are in a database named UserDB, there are three tables:
1. user table : storing uuid (universally unique
       identifier, as unique user id), real name , nick name and password
2. avatar table : storeing uuid and photo id
3. login talbe : storing login records, for security and user behavior study purpose
    
![image](http://alejandroseaah.com:4869/98336e55522fac37af942a20de1e5655?w=600&h=600)


Every user has a uuid, and all the tables share the same unique user id, this is the only field shared between all tables , data consistency is ensured by outside applications, not mysql itself.

With the simple connection between them, it is easy to split database when necessary.

* uuid is generated by /usr/bin/uuidgen on linux, with 36 letters.


## System APIs


### TCP Server
tcp server provide rpc service for query proxy, rpc call:

1. signUp(realName string, nickName string, pwd string, avatar string)

2. signIn(nickName string, pwd string)
3. editProfile(nickName string, avatar string)

### query proxy
For read query, query proxy will query redis first ,if result is found in redis ,then return the result directly to the client ,otherwise, query mysql and refresh the redis if query successfully\
For write query , query proxy will interact with mysql directly ,if write operation is successful, and redis will be update\
Query server interact with tcp server based on tcp protocol , provide serices to the http server based on http protocol.

#### tcp rpc call

1. signUp(realName string, nickName string, pwd string, avatar string)

2. signIn(nickName string, pwd string)
3. editProfile(nickName string, avatar string)

#### http api

1. /signup?rn=abc&nn=def&pwd=pwd&pic=pic
2. /login?nn=def&pwd=pwd

3. /edit
4. 


### http server

1. /signup
2. /login
3. /edit





## Basic System Design  


## Data Partitioning and Replication
## Redis Cache
## LoadBalance
We can add a Load balancing layer at some places in our system:
  1. Between http server and tcp servers
  2. Between tcp Servers and database servers
  3. Between http Servers and Cache servers
  ...

  
## Telemetry
How many times a used id has been used within 1 hour, what were user locations, etc.? How to store these statistics? Some statistics worth tracking: country of the visitor, date and time of access, web page that refers the click, browser or platform from where the page was accessed.


## Other considerations
replace mysql with MariaDB, Cassandra or Green plum ?


# repo

https://github.com/pkusnail/entry_task.git


# Reference:
1. https://www.datastax.com/dev/blog/2012-in-review-performance
2. https://mariadb.com/sites/default/files/A_Quick_Start_Guide_to_Backup_Technologies_-_MariaDB_White_Paper_-_08_26_13_001.pdf
3. http://www.eandbsoftware.org/wp-content/uploads/2015/03/MariaDB_vs_MySQL_-_MariaDB_White_Paper_-_08_26_13_001.pdf
4. https://dev.maxmind.com/geoip/
5. http://alejandroseaah.com:4869
6. https://golang.org/doc/articles/wiki/
7. 

